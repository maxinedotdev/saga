#!/usr/bin/env bash
set -euo pipefail

branch="$(git symbolic-ref --short HEAD 2>/dev/null || true)"

if [[ -z "$branch" ]]; then
  exit 0
fi

blocked_paths_pattern='^(openspec/|AGENTS\.md|\.kilocode/|plans/|promote-to-staging\.sh|staging-status\.sh)'
if git diff --cached --name-only | rg -n "$blocked_paths_pattern" >/dev/null 2>&1; then
  echo "ERROR: Commit includes local-only paths (openspec/ or other ignored artifacts). Remove them before committing." >&2
  exit 1
fi

case "$branch" in
  main)
    echo "ERROR: Commits to '$branch' are blocked locally. Use 'develop' or a feature branch." >&2
    exit 1
    ;;
  staging)
    merge_head_file="$(git rev-parse --git-path MERGE_HEAD)"
    if [[ -f "$merge_head_file" ]]; then
      merge_head="$(cat "$merge_head_file")"
      develop_head="$(git rev-parse develop 2>/dev/null || true)"
      if [[ -n "$develop_head" && "$merge_head" == "$develop_head" ]]; then
        exit 0
      fi
    fi
    echo "ERROR: Direct commits to 'staging' are blocked locally. Merge 'develop' into 'staging' to promote changes." >&2
    exit 1
    ;;
esac
